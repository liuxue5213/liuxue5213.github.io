<!DOCTYPE html>
<html lang="zh-CN">

  
<head>
  <meta charset="utf-8">
  <meta name="author" content="johnscott" />
  
  
  
  <title>91应急响应 | JohnScott2046的博客</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="网络安全,网络安全," />
  

  <script>
    console.log('\n%c Hexo-theme-bmw v4.0 ' + '%c 🎉 https://github.com/dongyuanxin/theme-bmw 🎉\n' + '\n%c View demo online ' + '%c 🔍 https://godbmw.com/ 🔍  \n' , 'color: #fadfa3; background: #030307; padding:3px 0;', '', 'color: #fadfa3; background: #030307; padding:3px 0;', '');
  </script>

  
    <meta name="description" content="超级帽子戏法的个人博客,主要记录复制粘贴过来的笔记,还有自己的一些心得体会">
  

  

  
    <link rel="icon" href="/images/favicon.ico">
    <link rel="apple-touch-icon" href="/images/touch-icon.png">
  

  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/icon/iconfont.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">


  
<script src="/js/util.js"></script>
<script src="/js/valine.min.js"></script>


  

  
    <link href="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.js" async></script>
  

  
    <link href="https://cdn.bootcss.com/social-share.js/1.0.16/css/share.min.css" rel="stylesheet">
  
  
  <script src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js" async></script>
  
  
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@3.11.0/dist/av-min.js"></script>
  

<meta name="generator" content="Hexo 5.1.1"></head>

  <body>
    <meta name="baidu-site-verification" content="code-gxYIK5UWjA" />
    

    <div id="app">

      <div class="header-wrap">
  <header>
    <div class="site-brand">
      <div class="site-title">
        <a href="/">JohnScott2046</a>
      </div>
    </div>
    <nav class="site-navigation">
      <ul class="nav-menu">
      
        <li class="nav-item" data-path="/">
          
            <a 
              href="/"
              target="_self"
            >
              主页
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/archives/">
          
            <a 
              href="/archives/"
              target="_self"
            >
              归档
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/categories/">
          
            <a 
              href="/categories/"
              target="_self"
            >
              分类
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/tags/">
          
            <a 
              href="/tags/"
              target="_self"
            >
              标签
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/friends/">
          
            <a 
              href="/friends/"
              target="_self"
            >
              友链
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/about/">
          
            <a 
              href="/about/"
              target="_self"
            >
              关于
            </a>
          
        </li>
      
        <li class="nav-item" data-path="">
          
            <a href="javascript:void(0);" v-else>联系我</a>
            <ul class="nav-menu--dropdown">
              
                <li>
                  <a 
                    href="https://github.com/liuxue5213" 
                    target="_blank"
                  >
                    Github
                  </a>
                </li>
              
                <li>
                  <a 
                    href="https://www.zhihu.com/people/liuxue5213" 
                    target="_blank"
                  >
                    知乎
                  </a>
                </li>
              
                <li>
                  <a 
                    href="http://weibo.com/liuxue5213" 
                    target="_blank"
                  >
                    微博
                  </a>
                </li>
              
                <li>
                  <a 
                    href="https://www.douban.com/people/liuxue5213" 
                    target="_blank"
                  >
                    豆瓣
                  </a>
                </li>
              
                <li>
                  <a 
                    href="/linkedin.com/in/liuxue5213" 
                    target="_blank"
                  >
                    linkedin
                  </a>
                </li>
              
            </ul>
          
        </li>
      
      </ul>
    </nav>
    <i class="iconfont icon-menu"></i>
  </header>
</div>

<script>
  let links = document.querySelectorAll('.nav-item');
  for(let link of links){
    let childrenLink = link.querySelector('ul');
    link.addEventListener('mouseenter', () => {
      if(childrenLink) {
        childrenLink.className = "nav-menu--dropdown active";
      }
    })
    link.addEventListener('mouseleave', () => {
      if(childrenLink) {
        childrenLink.className = "nav-menu--dropdown";
      }
    })
  }
  let rootRealPath = getRealPath(window.location.pathname, true);
  for(let link of links) {
    let linkPath = link.getAttribute("data-path");
    if(linkPath && getRealPath(linkPath, true) === rootRealPath) {
      link.className = "nav-item hover";
    }
  }

  let iconMenu = document.querySelector("i.iconfont.icon-menu"),
    iconMenuClicked = false;
  let navDOM = document.querySelector("nav.site-navigation");
  iconMenu.addEventListener("click", () => {
    iconMenuClicked 
      ? navDOM.className = "site-navigation active"
      : navDOM.className = "site-navigation";
    iconMenuClicked = !iconMenuClicked;
  })
</script>

      








<div class="container post-index">

  

<div class="post">
  <h1 class="article-title">
    <span>91应急响应</span>
  </h1>
  <div class="article-top-meta">
    <span>
      发布 : 
      2022-10-06
    </span>
    
      <span>
        分类 : 
          <a href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">
            网络安全
          </a>
      </span>
    
    
      <span>
        浏览 : <span class="article-timer" data-identity="91应急响应"></span>
      </span>
    
  </div>

  

  <div class="article-content">
    <div class="markdown-body">
      <h2 id="应急响应"><a href="#应急响应" class="headerlink" title="应急响应"></a>应急响应</h2><h3 id="火麒麟-FireKylin"><a href="#火麒麟-FireKylin" class="headerlink" title="火麒麟 FireKylin"></a>火麒麟 FireKylin</h3><p><a href="https://github.com/MountCloud/FireKylin">github</a></p>
<p><a href="https://github.com/MountCloud/FireKylin/releases">下载</a> </p>
<p>功能是收集操作系统各项痕迹，支持Windows和Linux痕迹收集。</p>
<p>作用是为分析研判安全事件提供操作系统数据。</p>
<p>目的是让任何有上机排查经验和无上机排查经验的人都可以进行上机排查安全事件。</p>
<p>在应对安全事件上机排查时，对于没有此方面经验但是有研判能力的安全专家来讲，经常苦于需要参考各种安全手册进行痕迹采集、整理、研判，此时我们可以使用FireKylin-Agent进行一键痕迹收集，降低排查安全专家收集工作的难度。</p>
<p>FireKylin的使用方式很简单，将Agent程序上传到需要检测的主机上，运行Agent程序，将采集到的数据.fkld文件下载下来，用界面程序加载数据就可以查看主机中的用户、进程、服务等信息，并且Agent最大的特点就是【0命令采集】对安装了监控功能的安全软件的主机来讲是非常友好的，不会对监控软件产生引起“误报安全事件”的命令。</p>
<h2 id="应急响应的原则和指导性思路"><a href="#应急响应的原则和指导性思路" class="headerlink" title="应急响应的原则和指导性思路"></a>应急响应的原则和指导性思路</h2><p>3W1H原则：3W即Who、What、Why，1H即How，做应急响应要带着疑问来做事，一定要收集清楚这些信息。网络拓扑是怎么样的？需求是啥？发生了什么事？你能做什么？用户用了什么产品？产品版本多少？病毒库版本多少？多少主机中了？主机是普通PC还是服务器？服务器是做什么的？……信息收集越多，对应急响应越有利。</p>
<p>易失性原则：做应急响应免不了要做信息收集和取证的，但这里是有一定的先后顺序的，即最容易丢失的据，应该最先收集，其它的依次类推。</p>
<p>要素原则：做应急响应，主要是抓关键证据，即要素，这些要素包括样本、流量、日志、进程及模块、内存、启动项。</p>
<p>避害原则：做应急响应，要做到趋利避害，不能问题还没有解决，反而引入了新的问题。譬如，自己使用的工具被感染而不知情；给用户使用不恰当的工具或软件造成客户主机出现问题；给别人发样本，不加密，不压缩，导致别人误点中毒，最极端的场景就是给别人发勒索样本不加密压缩，导致别人误点中毒。</p>
<p>应急工具集：应急响应必要的一套工具集合，可协助应急人员做分析，提高效率。</p>
<p>日志分析：能对日志进行分析，包括但不限于系统日志（Windows/Linux 等）、应用日志、安全设备日志（防火墙、防病毒、态势感知等）。</p>
<p>威胁情报：安全事件可能不是孤立的，安全站点或搜索站点能找到安全事件的关联信息。</p>
<p>漏洞补丁知识：知道漏洞与补丁的关系，它们在应急响应中的角色，了解常见漏洞及补丁。</p>
<p>常见病毒及分类：知道病毒大致的分类以及常见的病毒。</p>
<p>样本分析：至少能对样本进行一次简单动态的分析。</p>
<p>操作系统知识：至少对Windows系统和Linux系统的有一定的知识储备，知道其基础的工作原理。</p>
<h3 id="应急响应的流程（PDCERF）"><a href="#应急响应的流程（PDCERF）" class="headerlink" title="应急响应的流程（PDCERF）"></a>应急响应的流程（PDCERF）</h3><p>PDCERF方法学（最早由 1987 年美国宾夕法尼亚匹兹堡软件工程研究所在关于应急响应的邀请工作会议上提出），将应急响应分成准备（Preparation）、检测（Detection）、抑制（Containment）、根除（Eradication）、恢复（Recovery）、跟踪（Follow-up）6个阶段。</p>
<p>PDCERF模型在应急响应中的地位，约等于ISO七层模型在网络中的地位</p>
<p>按照顺序：</p>
<ol>
<li>准备阶段</li>
<li>检测阶段</li>
<li>抑制阶段</li>
<li>根除阶段</li>
<li>恢复阶段</li>
<li>跟踪总结</li>
</ol>
<h4 id="准备阶段"><a href="#准备阶段" class="headerlink" title="准备阶段"></a>准备阶段</h4><p>准备阶段需要及时和客户确认事件背景、相关负责人联系方式、确定参与此次应急响应人员、根据客户描述，初步判定事件响应策略，携带应急响应工具包前往客户现场。</p>
<p>准备阶段主要包括：事件背景、响应人员确定、事件响应策略、相关负责人联系方式、应急响应相关授权、应急响应工具包、应急响应手册等</p>
<h4 id="抑制阶段"><a href="#抑制阶段" class="headerlink" title="抑制阶段"></a>抑制阶段</h4><p>采用针对性的安全措施降低事件损失、避免安全事件的扩散和安全事件对受害系统的持续性破坏。主要分为：物理遏制、网络遏制、主机遏制、应用遏制等。常见手段：断网、降权、网络封堵等</p>
<h4 id="恢复阶段"><a href="#恢复阶段" class="headerlink" title="恢复阶段"></a>恢复阶段</h4><p>恢复系统的运行过程，就是把受影响系统、设备、软件和应用服务还原到正常的工作状态；系统恢复、网络恢复、用户恢复、数据恢复以及重新部署。常见手段：系统重装、补丁加固、网络恢复、密码重置、木马清除等</p>
<h4 id="跟踪阶段"><a href="#跟踪阶段" class="headerlink" title="跟踪阶段"></a>跟踪阶段</h4><p>在业务系统恢复后，需要整理一份详细的事件总结报告，包括事件发生及各部门介入处理的时间线，事件可能造成的损失，为客户提供安全加固优化建议。</p>
<p>跟踪阶段主要包括：调查事件原因，输出应急响应报告，提供安全建议、加强安全教育、避免同类事件再次发生</p>
<h3 id="应急响应的一般实操流程"><a href="#应急响应的一般实操流程" class="headerlink" title="应急响应的一般实操流程"></a>应急响应的一般实操流程</h3><ol>
<li>收集信息：收集客户信息和中毒主机信息，包括样本。</li>
<li>判断类型：判断是否是安全事件，何种安全事件，勒索、挖矿、断网、DoS等等。</li>
<li>深入分析：日志分析、进程分析、启动项分析、样本分析。</li>
<li>清理处置：直接杀掉进程，删除文件，打补丁，抑或是修复文件。</li>
<li>产出报告：整理并输出完整的安全事件报告</li>
</ol>
<h2 id="Linux入侵排查"><a href="#Linux入侵排查" class="headerlink" title="Linux入侵排查"></a>Linux入侵排查</h2><h3 id="账号安全"><a href="#账号安全" class="headerlink" title="账号安全"></a>账号安全</h3><p>基本使用：</p>
<ol>
<li><p>用户信息文件 /etc/passwd<br>root:x:0:0:root:/root:/bin/bash<br>• account:password:UID:GID:GECOS:directory:shell<br>用户名：密码：用户ID：组ID：用户说明：home目录：登陆之后的shell<br>注意：无密码只允许本机登陆，远程不允许登陆</p>
</li>
<li><p>影子文件 /etc/shadow<br>root:$6$oGs1PqhL2p3ZetrE$X7o7bzoouHQVSEmSgsYN5UD4.kMHx6qgbTqwNVC5oOAouXvcjQSt. Ft7ql1WpkopY0UV9ajBwUt1DpYxTCVvI/:16809:0:99999:7:::<br>用户名：加密密码：密码最后一次修改日期：两次密码的修改时间间隔：密码有效期：密码修改<br>到期到的警告天数：密码过期之后的宽限天数：账号失效时间：保留</p>
</li>
<li><p>和账号有关的命令<br>who 查看当前登录用户（tty 本地登陆 pts 远程登录）<br>w 查看系统信息，想知道某一时刻用户的行为<br>uptime 查看登陆多久、多少用户，负载状态</p>
</li>
</ol>
<p>查询特权用户特权用户(uid 为0)<br>awk -F: ‘$3==0{print $1}’ /etc/passwd</p>
<p>查询可以远程登录的帐号信息<br>awk ‘/$1|$6/{print $1}’ /etc/shadow</p>
<p>除root帐号外，其他帐号是否存在sudo权限。如非管理需要，普通帐号应删除sudo权限<br>more /etc/sudoers | grep -v “^#|^$” | grep “ALL=(ALL)”</p>
<p>禁用或删除多余及可疑的帐号<br>usermod -L user 禁用帐号，帐号无法登录，/etc/shadow 第二栏为 ! 开头<br>userdel user 删除user用户<br>userdel -r user 将删除user用户，并且将 /home 目录下的user目录一并删除</p>
<h3 id="历史命令"><a href="#历史命令" class="headerlink" title="历史命令"></a>历史命令</h3><p>root用户的历史命令 histroy  </p>
<p>进入用户目录下，导出历史命令<br>cat .bash_history &gt;&gt; history.txt</p>
<h3 id="检查异常端口"><a href="#检查异常端口" class="headerlink" title="检查异常端口"></a>检查异常端口</h3><p>使用 netstat 网络连接命令，分析可疑端口、IP、PID<br>netstat -antlp | more</p>
<p>查看pid所对应的进程文件路径</p>
<p>s -l /proc/$PID/exe 或<br>file /proc/$PID/exe（$PID 为对应的 pid 号）</p>
<h3 id="检查异常进程"><a href="#检查异常进程" class="headerlink" title="检查异常进程"></a>检查异常进程</h3><p>使用 ps 命令，分析进程<br>ps aux | grep pid<br>ps -ef | grep pname</p>
<h3 id="检查开机启动项"><a href="#检查开机启动项" class="headerlink" title="检查开机启动项"></a>检查开机启动项</h3><p>系统运行级别示意图</p>
<p>运行级别 含义<br>0   关机<br>1   单用户模式，可以想象为windows的安全模式，主要用于系统修复<br>2   不完全的命令行模式，不含NFS服务<br>3   完全的命令行模式，就是标准字符界面<br>4   系统保留<br>5   图形模式<br>6   重启动</p>
<p>查看运行级别命令 runlevel<br>系统默认允许级别</p>
<p>vi /etc/inittab<br>id=3：initdefault 系统开机后直接进入哪个运行级别</p>
<p>开机启动配置文件<br>/etc/rc.local<br>/etc/rc.d/rc[0~6].d</p>
<p>说明：当我们需要开机启动自己的脚本时，只需要将可执行脚本丢在 /etc/init.d 目录下，然后在 <code>/etc/rc.d/rc*.d</code> 文件中建立软链接即可</p>
<h3 id="检查定时任务"><a href="#检查定时任务" class="headerlink" title="检查定时任务"></a>检查定时任务</h3><ol>
<li>利用 crontab 创建计划任务</li>
</ol>
<p>基本命令<br>crontab -l 列出某个用户cron服务的详细内容<br>Tips：默认编写的crontab文件会保存在 (/var/spool/cron/用户名 例如:/var/spool/cron/root<br>crontab -r 删除每个用户cront任务(谨慎：删除所有的计划任务)<br>crontab -e 使用编辑器编辑当前的crontab文件<br>如：<code>*/1 * * * * echo &quot;hello world&quot; &gt;&gt; /tmp/test.txt</code> 每分钟写入文件</p>
<p>重点关注以下目录中是否存在恶意脚本<br>/var/spool/cron/*<br>/etc/crontab<br>/etc/cron.d/*<br>/etc/cron.daily/*<br>/etc/cron.hourly/*<br>/etc/cron.monthly/*<br>/etc/cron.weekly/<br>/etc/anacrontab<br>/var/spool/anacron/*</p>
<h3 id="检查服务"><a href="#检查服务" class="headerlink" title="检查服务"></a>检查服务</h3><p>服务自启动</p>
<p>第一种修改方法：<br>chkconfig [–level 运行级别] [独立服务名] [on|off]<br>chkconfig –level 2345 httpd on 开启自启动<br>chkconfig httpd on （默认level是2345）</p>
<p>第二种修改方法：<br>修改 /etc/re.d/rc.local 文件<br>加入 /etc/init.d/httpd start</p>
<p>第三种修改方法：<br>使用 ntsysv 命令管理自启动，可以管理独立服务和 xinetd 服务</p>
<p>查询已安装的服务：<br>RPM 包安装的服务<br>chkconfig –list 查看服务自启动状态，可以看到所有的RPM包安装的服务<br>ps aux | grep crond 查看当前服务</p>
<p>源码包安装的服务<br>查看服务安装位置 ，一般是在/user/local/<br>service httpd start<br>搜索/etc/rc.d/init.d/ 查看是否存在</p>
<h3 id="检查异常文件"><a href="#检查异常文件" class="headerlink" title="检查异常文件"></a>检查异常文件</h3><ol>
<li><p>查看敏感目录，如/tmp目录下的文件，同时注意隐藏文件夹，以“..”为名的文件夹具有隐藏属性</p>
</li>
<li><p>得到发现WEBSHELL、远控木马的创建时间，如何找出同一时间范围内创建的文件</p>
</li>
</ol>
<p>可以使用find命令来查找<br><code>find /opt -iname &quot;*&quot; -atime 1 -type f</code>  找出/opt下一天前访问过的文件</p>
<ol start="3">
<li>针对可疑文件可以使用 stat 进行创建修改时间</li>
</ol>
<h3 id="检查系统日志"><a href="#检查系统日志" class="headerlink" title="检查系统日志"></a>检查系统日志</h3><p>日志默认存放位置：/var/log/</p>
<p>查看日志配置情况：more /etc/rsyslog.conf</p>
<p>比较重要的几个日志：</p>
<ol>
<li>登录失败记录：/var/log/btmp //lastb</li>
<li>最后一次登录：/var/log/lastlog //lastlog</li>
<li>登录成功记录: /var/log/wtmp //last</li>
<li>登录日志记录：/var/log/secure</li>
</ol>
<p>目前登录用户信息：/var/run/utmp //w、who、users</p>
<p>历史命令记录：history 仅清理当前用户： history -</p>
<p>日志默认存放位置：/var/log/<br>查看日志配置情况：more /etc/rsyslog.conf</p>
<p>/var/log/cron 记录了系统定时任务相关的日志<br>/var/log/cups 记录打印信息的日志<br>/var/log/dmesg 记录了系统在开机时内核自检的信息，也可以使用dmesg命令直接查看内核自检信息<br>/var/log/mailog 记录邮件信息<br>/var/log/message 记录系统重要信息的日志。这个日志文件中会记录Linux系统的绝大多数重要信息，如果系统出现问题时，首先要检查的就应该是这个日志文件<br>/var/log/btmp 记录错误登录日志，这个文件是二进制文件，不能直接vi查看，而要使用lastb命令查看<br>/var/log/lastlog 记录系统中所有用户最后一次登录时间的日志，这个文件是二进制文件，不能直接vi，而要使用lastlog命令查看<br>/var/log/wtmp 永久记录所有用户的登录、注销信息，同时记录系统的启动、重启、关机事件。同样这个文件也是一个二进制文件，不能直接vi，而需要使用last命令来查看<br>/var/log/utmp 记录当前已经登录的用户信息，这个文件会随着用户的登录和注销不断变化，只记录当前登录用户的信息。同样这个文件不能直接vi，而要使用w,who,users等命令来查询<br>/var/log/secure 记录验证和授权方面的信息，只要涉及账号和密码的程序都会记录，比如SSH登录，su切换用户，sudo授权，甚至添加用户和修改用户密码都会记录在这个日志文件中</p>
<p>日志分析常用命令：</p>
<ol>
<li><p>定位有多少IP在爆破主机的root帐号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &quot;Failed password for root&quot; &#x2F;var&#x2F;log&#x2F;secure | awk &#39;&#123;print $11&#125;&#39; | sort | uniq -c | sort -nr | more</span><br></pre></td></tr></table></figure>
</li>
<li><p>定位有哪些IP在爆破</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &quot;Failed password&quot; &#x2F;var&#x2F;log&#x2F;secure|grep -E -o &quot;(25[0-5]|2[0-4][0-9]|[01]?[0- 9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0- 9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)&quot;|uniq -c</span><br></pre></td></tr></table></figure>
</li>
<li><p>爆破用户名字典是什么</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &quot;Failed password&quot; &#x2F;var&#x2F;log&#x2F;secure|perl -e &#39;while($_&#x3D;&lt;&gt;)&#123; &#x2F;for(.*?) from&#x2F;;print &quot;$1\n&quot;;&#125;&#39;|uniq -c|sort -nr</span><br></pre></td></tr></table></figure>
</li>
<li><p>登录成功的IP有哪些</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &quot;Accepted &quot; &#x2F;var&#x2F;log&#x2F;secure | awk &#39;&#123;print $11&#125;&#39; | sort | uniq -c | sort -nr | more</span><br></pre></td></tr></table></figure>
</li>
<li><p>登录成功的日期、用户名、IP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &quot;Accepted &quot; &#x2F;var&#x2F;log&#x2F;secure | awk &#39;&#123;print $1,$2,$3,$9,$11&#125;&#39;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看增加一个用户的kali日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &quot;useradd&quot; &#x2F;var&#x2F;log&#x2F;secure</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>Jul 10 00:12:15 localhost useradd[2382]: new group: name=kali,GID=1001</p>
<p>Jul 10 00:12:15 localhost useradd[2382]: new user: name=kali,UID=1001, GID=1001, home=/home/kali</p>
<p>,shell=/bin/bash</p>
<p>Jul 10 00:12:58 localhost passwd: pam_unix(passwd:chauthtok):password changed for kali</p>
<ol start="7">
<li>查看删除用户kali日志<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &quot;userdel&quot; &#x2F;var&#x2F;log&#x2F;secure</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>Jul 10 00:14:17 localhost userdel[2393]: delete user ‘kali’</p>
<p>Jul 10 00:14:17 localhost userdel[2393]: removed group ‘kali’ owned by ‘kali’</p>
<p>Jul 10 00:14:17 localhost userdel[2393]: removed shadow group ‘kali’ owned by ‘kali’</p>
<ol start="8">
<li>su切换用户</li>
</ol>
<p>Jul 10 00:38:13 localhost su: pam_unix(su-l:session): session opened for user good by root(uid=0)</p>
<p>sudo授权执行: sudo -l</p>
<p>Jul 10 00:43:09 localhost sudo: good : TTY=pts/4 ; PWD=/home/good ; USER=root ; COMMAND=/sbin/shutdown -r now</p>
<ol start="9">
<li>软件安装升级卸载日志</li>
</ol>
<p>more /var/log/yum.log</p>
<h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><p>Rootkit查杀 Chkrootkit<br>网址：<a target="_blank" rel="noopener" href="http://www.chkrootkit.org/">http://www.chkrootkit.org</a></p>
<p>Rkhunter<br>网址：<a target="_blank" rel="noopener" href="http://rkhunter.sourceforge.net/">http://rkhunter.sourceforge.net</a></p>
<p>病毒查杀 Clamav<br>网址：<a target="_blank" rel="noopener" href="http://www.clamav.net/download.html">http://www.clamav.net/download.html</a></p>
<p>webshell查杀<br>Linux版：河马WebShell查杀：<a target="_blank" rel="noopener" href="http://www.shellpub.com/">http://www.shellpub.com</a></p>
<h2 id="Linux权限维持破除隐藏以及后门清除"><a href="#Linux权限维持破除隐藏以及后门清除" class="headerlink" title="Linux权限维持破除隐藏以及后门清除"></a>Linux权限维持破除隐藏以及后门清除</h2><h3 id="隐藏文件"><a href="#隐藏文件" class="headerlink" title="隐藏文件"></a>隐藏文件</h3><p>隐藏：<br>Linux下，文件名称前面有“.”的就是隐藏文件，使用ls –l看隐藏文件</p>
<p>破除隐藏：ls –al<br>提示：一般在/tmp下，默认存在多个隐藏目录，这些目录是恶意文件常用来藏身的地方。如/temp/.ICE-unix/、/temp/.Test-unix/、/temp/.X11-unix/、/temp/.XIM-unix/</p>
<h3 id="隐藏文件时间戳"><a href="#隐藏文件时间戳" class="headerlink" title="隐藏文件时间戳"></a>隐藏文件时间戳</h3><p>隐藏：<br>touch -r index.php webshell.php 将index.php的时间戳赋给webshell.php<br>touch -t 1401021042.30 webshell.php 修改时间戳为2014年01月02日</p>
<p>破除隐藏：<br>stat webshell.php 查看<br>ls -al –time=ctime webshell.php</p>
<p>说明：chmod、chown等修改文件权限、所有者，所属组的操作，会更新atime和ctime的值</p>
<h3 id="隐藏权限"><a href="#隐藏权限" class="headerlink" title="隐藏权限"></a>隐藏权限</h3><p>隐藏：<br>在Linux中，使用chattr命令来防止root和其他管理用户误删除和修改重要文件及目录，此权限用ls -l是查看不出来的，从而达到隐藏权限的目的。<br>这个技巧常被用在后门，变成了一些难以清除的后门文件</p>
<p>破除隐藏：<br>chattr +i evil.php 锁定文件<br>lsattr evil.php 属性查看<br>chattr -i evil.php 解除锁定<br>rm -rf 1.evil.php 删除文件</p>
<h3 id="隐藏历史操作命令"><a href="#隐藏历史操作命令" class="headerlink" title="隐藏历史操作命令"></a>隐藏历史操作命令</h3><p>隐藏：</p>
<p>1.只针对工作关闭历史记录<br>[space]set +o history<br>备注：[space] 表示空格。并且由于空格的缘故，该命令本身也不会被记录。上面的命令会临时禁用历史功能，这意味着在这命令之后你执行的所有操作都不会记录到历史中，然而这个命令之前的所有东西都会原样记录在历史列表中。</p>
<p>破除隐藏：<br>重新开启历史功能，执行下面的命令：[Space]set -o history<br>它将环境恢复原状，也就是你完成了你的工作，执行上述命令之后的命令都会出现在历史中。</p>
<p>2.从历史记录中删除指定的命令<br>history | grep “keyword“，命令会输出历史记录中匹配的命令，每一条前面会有个数字。</p>
<p>从历史记录中删除那个指定的项：history -d [num]<br>只保留前150行：sed -i ‘150,$d’ .bash_history</p>
<p>破除隐藏：<br>提前备份.bash_history文件</p>
<h3 id="隐藏远程SSH登陆记录"><a href="#隐藏远程SSH登陆记录" class="headerlink" title="隐藏远程SSH登陆记录"></a>隐藏远程SSH登陆记录</h3><p>隐身登录系统，不会被w、who、last等指令检测到。<br>ssh -T <a href="mailto:&#114;&#x6f;&#111;&#116;&#64;&#49;&#50;&#x37;&#46;&#x30;&#46;&#48;&#x2e;&#49;">&#114;&#x6f;&#111;&#116;&#64;&#49;&#50;&#x37;&#46;&#x30;&#46;&#48;&#x2e;&#49;</a> /bin/bash –i</p>
<p>不记录ssh公钥在本地.ssh目录中<br>ssh -o UserKnownHostsFile=/dev/null -T user@host /bin/bash –i</p>
<h3 id="端口复用"><a href="#端口复用" class="headerlink" title="端口复用"></a>端口复用</h3><p>利用IPTables进行端口复用</p>
<ol>
<li><p>端口复用链<br>iptables -t nat -N LETMEIN</p>
</li>
<li><p>端口复用规则<br>iptables -t nat -A LETMEIN -p tcp -j REDIRECT –to-port 22</p>
</li>
</ol>
<p>开启开关<br>iptables -A INPUT -p tcp -m string –string ‘threathuntercoming’ –algo bm -m recent –set –name letmein –rsource -j ACCEPT</p>
<p>关闭开关<br>iptables -A INPUT -p tcp -m string –string ‘threathunterleaving’ –algo bm -m recent – name letmein –remove -j ACCEPT</p>
<p>立即執行<br>iptables -t nat -A PREROUTING -p tcp –dport 80 –syn -m recent –rcheck –seconds 3600 –name letmein –rsource -j LETMEIN</p>
<p>检测：<br>Netstat查看监听端口</p>
<h3 id="进程隐藏"><a href="#进程隐藏" class="headerlink" title="进程隐藏"></a>进程隐藏</h3><p>说明：管理员无法通过相关命令工具查找到你运行的进程，从而达到隐藏目的，实现进程隐藏。</p>
<p>利用办法：<br>进程注入工具linux-inject<br>github项目地址： <a href="https://github.com/gaffe23/linux-inject.git">https://github.com/gaffe23/linux-inject.git</a></p>
<p>下载程序编译 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;gaffe23&#x2F;linux-inject.git</span><br><span class="line">cd linux-inject &amp;&amp; make</span><br></pre></td></tr></table></figure>

<p>测试进程<br>./sample-target</p>
<p>进程注入<br>./inject -n sample-target sample-library.so</p>
<p>破除隐藏：<br>unhide 是一个小巧的网络取证工具，能够发现那些借助rootkit，LKM及其它技术隐藏的进程和TCP / UDP端口。这个工具在Linux，UNIX类，MS-Windows等操作系统下都可以工作。</p>
<p>下载地址：<a target="_blank" rel="noopener" href="http://www.unhide-forensics.info/">http://www.unhide-forensics.info/</a></p>
<p>安装<br>sudo yum install unhide</p>
<p>使用<br>unhide [options] test_list<br>使用unhide proc发现隐藏进程evil_script.py</p>
<h2 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h2><p>当企业发生黑客入侵、系统崩溃或其它影响业务正常运行的安全事件时，急需第一时间进行处理，使企业的网络信息系统在最短时间内恢复正常工作，进一步查找入侵来源，还原入侵事故过程，同时给出解决方案与防范措施，为企业挽回或减少经济损失。</p>
<p>常见的应急响应事件分类</p>
<ol>
<li>Web入侵：网页挂马、主页篡改、Webshell</li>
<li>系统入侵：病毒木马、勒索软件、远控后门</li>
<li>网络攻击：DDOS攻击、DNS劫持、ARP欺骗</li>
</ol>
<h3 id="入侵排查"><a href="#入侵排查" class="headerlink" title="入侵排查"></a>入侵排查</h3><h4 id="检查系统账号安全"><a href="#检查系统账号安全" class="headerlink" title="检查系统账号安全"></a>检查系统账号安全</h4><ol>
<li><p>查看服务器是否有弱口令，远程管理端口是否对公网开放。<br>检查方法：据实际情况咨询相关服务器管理员。</p>
</li>
<li><p>查看服务器是否存在可疑账号、新增账号。<br>检查方法：打开 cmd 窗口，输入 lusrmgr.msc 命令，查看是否有新增/可疑的账号，<br>如有管理员群组的（Administrators）里的新增账户，如有立即禁用或删除掉</p>
</li>
<li><p>查看服务器是否存在隐藏账号、克隆账号。<br>检查方法：<br>a、打开注册表 ，查看管理员对应键值。<br>b、使用D盾_web查杀工具，集成了对克隆账号检测的功能。<br>c、使用工具：<a href="https://github.com/wgpsec/CreateHiddenAccount">https://github.com/wgpsec/CreateHiddenAccount</a></p>
</li>
<li><p>检查当前系统的隐藏账号：CreateHiddenAccount.exe -c<br>删除 teamssix 隐藏账号：CreateHiddenAccount.exe -d teamssix</p>
</li>
<li><p>结合日志，查看管理员登录时间、用户名是否存在异常。<br>检查方法：<br>a、Win+R 打开运行，输入”eventvwr.msc”，回车运行，打开“事件查看器”。<br>b、导出 Windows 日志 – 安全，利用微软官方工具 Log Parser 进行分析</p>
</li>
</ol>
<h4 id="检查异常端口、进程"><a href="#检查异常端口、进程" class="headerlink" title="检查异常端口、进程"></a>检查异常端口、进程</h4><p>检查端口连接情况，是否有远程连接、可疑连接方法：<br>a、使用netstat -ano 命令查看目前的网络连接，定位可疑的 ESTABLISHED<br>b、根据 netstat 命令定位出的 PID 编号，再通过 tasklist 命令进行进程定位 tasklist | findstr “PID“</p>
<p>进程检查方法：<br>a、开始 – 运行 – 输入 msinfo32 命令，依次点击 “软件环境 – 正在运行任务” 就可以查看到进程的详<br>细信息，比如进程路径、进程ID、文件创建日期以及启动时间等。<br>b、打开D盾_web查杀工具，进程查看，关注没有签名信息的进程。<br>c、通过微软官方提供的 Process Explorer 等工具进行排查 。<br>d、火绒剑。<br>e、查看可疑的进程及其子进程。<br>可以通过观察以下内容：<br>  没有签名验证信息的进程<br>  没有描述信息的进程<br>  进程的属主<br>  进程的路径是否合法<br>  CPU或内存资源占用长时间过高的进程</p>
<p>小技巧：<br>a、查看端口对应的 PID：netstat -ano | findstr “port”<br>b、查看进程对应的 PID：任务管理器 – 查看 – 选择列 – PID 或者 tasklist | findstr “PID”<br>c、查看进程对应的程序位置：<br>  任务管理器 – 选择对应进程 – 右键打开文件位置<br>  运行输入 wmic，cmd 界面输入 process<br>d、tasklist /svc 进程 – PID – 服务<br>e、查看Windows服务所对应的端口： %systemroot%/system32/drivers/etc/services<br>（一般 %systemroot% 就是 C:\Windows 路径）</p>
<h3 id="权限维持排查"><a href="#权限维持排查" class="headerlink" title="权限维持排查"></a>权限维持排查</h3><h4 id="服务器是否有异常的启动项检查方法"><a href="#服务器是否有异常的启动项检查方法" class="headerlink" title="服务器是否有异常的启动项检查方法"></a>服务器是否有异常的启动项检查方法</h4><p>a、登录服务器(默认情况下此目录在是一个空目录，确认是否有非业务程序在该目录下)。<br>  系统启动文件夹：c:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp<br>  资源管理器打开“系统启动文件夹”的命令，shell:Common Startup<br>  用户启动文件夹：c:\Users\用户名\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup<br>  资源管理器打开“用户启动文件夹”的命令，shell:startup<br>b、单击开始菜单 &gt;【运行 】，输入 msconfig，查看是否存在命名异常的启动项目，是则取消勾选命名异常的启动项目，并到命令中显示的路径删除文件。<br>c、单击【开始】&gt;【运行】，输入 regedit，打开注册表，查看开机启动项是否正常，特别注意如下三个注册表项：<br>  HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\run<br>  HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run<br>  HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Runonce<br>  检查右侧是否有启动异常的项目，如有请删除，并建议安装杀毒软件进行病毒查杀，清除残留病毒或木马。<br>d、利用安全软件查看启动项、开机时间管理等。<br>e、组策略，运行 <code>gpedit.msc</code></p>
<h4 id="计划任务检查方法"><a href="#计划任务检查方法" class="headerlink" title="计划任务检查方法"></a>计划任务检查方法</h4><p>a、单击【开始】&gt;【设置】&gt;【控制面板】&gt;【任务计划】，查看计划任务属性，便可以发现木马文件的路径。<br>b、单击【开始】&gt;【运行】；输入 <code>cmd</code>，然后输入 <code>at</code>，检查计算机与网络上的其它计算机之间的会话或计划任务，如有，则确认是否为正常连接</p>
<h4 id="服务自启动检查方法"><a href="#服务自启动检查方法" class="headerlink" title="服务自启动检查方法"></a>服务自启动检查方法</h4><p>单击【开始】&gt;【运行】，输入 <code>services.msc</code>，注意服务状态和启动类型，检查是否有异常服务</p>
<h3 id="检查系统相关信息"><a href="#检查系统相关信息" class="headerlink" title="检查系统相关信息"></a>检查系统相关信息</h3><h4 id="1-查看系统版本以及补丁信息检查方法"><a href="#1-查看系统版本以及补丁信息检查方法" class="headerlink" title="1. 查看系统版本以及补丁信息检查方法"></a>1. 查看系统版本以及补丁信息检查方法</h4><p>单击【开始】&gt;【运行】，输入 <code>systeminfo</code>，查看系统信息。</p>
<h4 id="2-查找可疑目录及文件"><a href="#2-查找可疑目录及文件" class="headerlink" title="2. 查找可疑目录及文件"></a>2. 查找可疑目录及文件</h4><p>a、 查看用户目录，新建账号会在这个目录生成一个用户目录，查看是否有新建用户目录。<br>  Window 2003版本 C:\Documents and Settings<br>  Window 2008R2及以后版本 C:\Users<br>b、单击【开始】&gt;【运行】，输入 <code>%UserProfile%\Recent</code>，分析最近打开分析可疑文件。<br>c、在服务器各个目录，可根据文件夹内文件列表时间进行排序，查找可疑文件。<br>d、回收站、浏览器下载目录、浏览器历史记录<br>e、修改时间在创建时间之前的为可疑文件</p>
<h3 id="3-找出同一时间范围内创建的文件"><a href="#3-找出同一时间范围内创建的文件" class="headerlink" title="3. 找出同一时间范围内创建的文件"></a>3. 找出同一时间范围内创建的文件</h3><p>发现并得到 WebShell、远控木马的创建时间，如何找出同一时间范围内创建的文件？<br>a、利用 <a target="_blank" rel="noopener" href="http://www.torchsoft.com/en/rw_information.html">Registry Workshop</a> 注册表编辑器的搜索功能，可以找到最后写入时间区间的文件<br>b、利用计算机自带文件搜索功能，指定修改时间进行搜索</p>
<h3 id="自动化查杀"><a href="#自动化查杀" class="headerlink" title="自动化查杀"></a>自动化查杀</h3><ol>
<li><p>病毒查杀检查方法<br>下载安全软件，更新最新病毒库，进行全盘扫描。</p>
</li>
<li><p>webshell查杀检查方法<br>选择具体站点路径进行webshell查杀，建议使用两款WebShell查杀工具同时查杀，可相互补充规则库的不足</p>
</li>
</ol>
<h3 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h3><ol>
<li><p>系统日志分析方法：<br>a、前提：开启审核策略，若日后系统出现故障、安全事故则可以查看系统的日志文件，排除故障，追查入侵者的信息等。<br>b、Win+R 打开运行，输入 “eventvwr.msc”，回车运行，打开”事件查看器”。<br>C、导出应用程序日志、安全日志、系统日志，利用 <a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/download/details.aspx?id=24659">Log Parser</a> 进行分析。</p>
</li>
<li><p>Web 访问日志分析方法：<br>a、找到中间件的web日志，打包到本地方便进行分析。<br>b、推荐工具：Windows 下，推荐用 EmEditor 进行日志分析，支持大文本，搜索效率还不错。Linux 下，使用 Shell 命令组合查询分析</p>
</li>
</ol>
<h2 id="病毒处理"><a href="#病毒处理" class="headerlink" title="病毒处理"></a>病毒处理</h2><h3 id="病毒分析工具"><a href="#病毒分析工具" class="headerlink" title="病毒分析工具"></a>病毒分析工具</h3><p>PCHunter：<a target="_blank" rel="noopener" href="http://www.xuetr.com/">http://www.xuetr.com</a><br>火绒剑：<a target="_blank" rel="noopener" href="https://www.huorong.cn/">https://www.huorong.cn</a><br>Process Explorer：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zhcn/sysinternals/downloads/process-explorer">https://docs.microsoft.com/zhcn/sysinternals/downloads/process-explorer</a><br>processhacker：<a target="_blank" rel="noopener" href="https://processhacker.sourceforge.io/downloads.php">https://processhacker.sourceforge.io/downloads.php</a><br>autoruns：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/enus/sysinternals/downloads/autoruns">https://docs.microsoft.com/enus/sysinternals/downloads/autoruns</a><br>OTL：<a target="_blank" rel="noopener" href="https://www.bleepingcomputer.com/download/otl/">https://www.bleepingcomputer.com/download/otl/</a><br>SysInspector：<a target="_blank" rel="noopener" href="http://download.eset.com.cn/download/detail/?product=sysinspector">http://download.eset.com.cn/download/detail/?product=sysinspector</a></p>
<h3 id="病毒查杀"><a href="#病毒查杀" class="headerlink" title="病毒查杀"></a>病毒查杀</h3><p>卡巴斯基：<a target="_blank" rel="noopener" href="http://devbuilds.kasperskylabs.com/devbuilds/KVRT/latest/full/KVRT.exe">http://devbuilds.kasperskylabs.com/devbuilds/KVRT/latest/full/KVRT.exe</a> （推荐理由：绿色版、最新病毒库）<br>大蜘蛛：<a target="_blank" rel="noopener" href="http://free.drweb.ru/download+cureit+free%EF%BC%88%E6%8E%A8%E8%8D%90%E7%90%86%E7%94%B1%EF%BC%9A%E6%89%AB%E6%8F%8F%E5%BF%AB%E3%80%81%E4%B8%80%E6%AC%A1%E4%B8%8B%E8%BD%BD%E5%8F%AA%E8%83%BD%E7%94%A81%E5%91%A8%EF%BC%8C%E6%9B%B4%E6%96%B0%E7%97%85%E6%AF%92%E5%BA%93%EF%BC%89">http://free.drweb.ru/download+cureit+free（推荐理由：扫描快、一次下载只能用1周，更新病毒库）</a><br>火绒安全软件：<a target="_blank" rel="noopener" href="https://www.huorong.cn/">https://www.huorong.cn</a><br>360杀毒：<a target="_blank" rel="noopener" href="http://sd.360.cn/download_center.html">http://sd.360.cn/download_center.html</a></p>
<h3 id="病毒动态"><a href="#病毒动态" class="headerlink" title="病毒动态"></a>病毒动态</h3><p>CVERC-国家计算机病毒应急处理中心：<a target="_blank" rel="noopener" href="http://www.cverc.org.cn/">http://www.cverc.org.cn</a><br>微步在线威胁情报社区：<a target="_blank" rel="noopener" href="https://x.threatbook.cn/">https://x.threatbook.cn</a><br>火绒安全论坛：<a target="_blank" rel="noopener" href="http://bbs.huorong.cn/forum-59-1.html">http://bbs.huorong.cn/forum-59-1.html</a><br>爱毒霸社区：<a target="_blank" rel="noopener" href="http://bbs.duba.net/">http://bbs.duba.net</a><br>腾讯电脑管家：<a target="_blank" rel="noopener" href="http://bbs.guanjia.qq.com/forum-2-1.html">http://bbs.guanjia.qq.com/forum-2-1.html</a></p>
<h3 id="在线病毒扫描网站"><a href="#在线病毒扫描网站" class="headerlink" title="在线病毒扫描网站"></a>在线病毒扫描网站</h3><p>Virustotal：<a target="_blank" rel="noopener" href="https://www.virustotal.com/">https://www.virustotal.com</a><br>Virscan：<a target="_blank" rel="noopener" href="http://www.virscan.org/">http://www.virscan.org</a><br>腾讯哈勃分析系统：<a target="_blank" rel="noopener" href="https://habo.qq.com/">https://habo.qq.com</a><br>Jotti 恶意软件扫描系统：<a target="_blank" rel="noopener" href="https://virusscan.jotti.org/">https://virusscan.jotti.org</a></p>
<h3 id="webshell查杀"><a href="#webshell查杀" class="headerlink" title="webshell查杀"></a>webshell查杀</h3><p>D盾_Web查杀：<a target="_blank" rel="noopener" href="http://www.d99net.net/index.asp">http://www.d99net.net/index.asp</a><br>河马WebShell查杀：<a target="_blank" rel="noopener" href="http://www.shellpub.com/">http://www.shellpub.com</a></p>
<h2 id="windows权限维持破除隐藏"><a href="#windows权限维持破除隐藏" class="headerlink" title="windows权限维持破除隐藏"></a>windows权限维持破除隐藏</h2><p>攻击者在获取服务器后，通常用一些后门来维持权限，如果想让后门保持更久，就要隐藏好，使之不易被管理员发现</p>
<h3 id="利用文件属性"><a href="#利用文件属性" class="headerlink" title="利用文件属性"></a>利用文件属性</h3><p>隐藏：最简单的一种隐藏文件的方式，文件右键属性，勾选隐藏，点击确定后，在这个文件里看不到刚刚的文件了。<br>破除隐藏：点击查看，勾选显示隐藏的文件，文件就显示出来。</p>
<p>高级隐藏：使用Attrib +s +a +h +r 命令<br>把原本的文件夹增加了系统文件属性、存档文件属性、只读文件属性和隐藏文件属性。<br><code>attrib +s +a +h +r D:\test\project\test.txt</code><br>破除高级破除隐藏：打开电脑文件夹选项卡，取消”隐藏受保护的操作系统文件“勾选，把”隐藏文件和文件夹“下面的单选选择“显示隐藏的文件、文件夹和驱动器”</p>
<h3 id="利用ADS隐藏文件内容"><a href="#利用ADS隐藏文件内容" class="headerlink" title="利用ADS隐藏文件内容"></a>利用ADS隐藏文件内容</h3><p>隐藏：在服务器上echo一个数据流文件进去，比如index.php是网页正常文件<br><code>echo ^&lt;?php @eval($_POST[&#39;chopper&#39;]);?^&gt; &gt; index.php:hidden.jpg</code><br>这样子就生成了一个不可见的shell hidden.jpg<br>使用常规的文件管理器、type命令，dir命令、del命令发现都找不出那个hidden.jpg的。</p>
<p>查看index.php:hidden.jpg内容<br>进入文件所在目录，notepad index.php:hidden.jpg 或者 dir /r</p>
<p>删除index.php:hidden.jpg<br>直接删除index.php即可</p>
<h3 id="驱动级文件隐藏"><a href="#驱动级文件隐藏" class="headerlink" title="驱动级文件隐藏"></a>驱动级文件隐藏</h3><p>隐藏：<br>驱动隐藏可以用一些软件来实现，软件名字叫：Easy File Locker<br>下载链接： <a target="_blank" rel="noopener" href="http://www.xoslab.com/efl.html">http://www.xoslab.com/efl.html</a></p>
<p>破除隐藏：</p>
<ol>
<li><p>确认是否隐藏<br>如果网站目录未查找到相关文件，且系统目录存在存在以下文件：<br>c:\WINDOWS\xlkfs.dat<br>c:\WINDOWS\xlkfs.dll<br>c:\WINDOWS\xlkfs.ini<br>c:\WINDOWS\system32\drivers\xlkfs.sys<br>那么应该是遭遇了驱动级文件隐藏。</p>
</li>
<li><p>实施清除：<br>查询服务状态： sc qc xlkfs<br>停止服务： net stop xlkfs 服务停止以后，经驱动级隐藏的文件即可显现<br>删除服务： sc delete xlkfs<br>删除系统目录下面的文件，重启系统，确认服务已经被清理了。</p>
</li>
</ol>
<p>提示：隐藏文件的方式还有很多，比如伪装成一个系统文件夹图标，利用畸形文件名、保留文件名无法删除，甚至取一个与系统文件很像的文件名并放在正常目录里面，很难辨别出来。</p>
<h3 id="隐藏账号"><a href="#隐藏账号" class="headerlink" title="隐藏账号"></a>隐藏账号</h3><p>隐藏：<br>window 隐藏系统用户操作，CMD命令行下，建立了一个用户名为“test$”，密码为“abc123!”的简单隐藏账户,并且把该隐藏账户提升为了管理员权限。</p>
<p>破除隐藏：<br>使用D盾_web查杀工具，使用克隆账号检测功能进行查看，可检测出隐藏、克隆账号。</p>
<h3 id="端口复用-1"><a href="#端口复用-1" class="headerlink" title="端口复用"></a>端口复用</h3><p>隐藏：<br>可以使用WinRM服务或者其他的工具实现端口复用</p>
<p>破除隐藏：<br>复用时会在安全日志中留下痕迹</p>
<h3 id="进程注入"><a href="#进程注入" class="headerlink" title="进程注入"></a>进程注入</h3><p>隐藏：<br>进程注入，一直是病毒木马的惯用手段，同时，它也是一种隐藏技术。</p>
<p>破除隐藏：</p>
<ol>
<li>通过TCPview显示已建立的TCP连接，我们可以看到异常的连接，同时，恶意软件将以绿色显示不到一秒钟，然后变成红色消失，如此循环。</li>
<li>利用process monitor或者火绒剑监控进程都可以定位到注入进程。</li>
<li>利用process monitor捕捉通信过程，有规律的请求取决于sleep设置的间隔</li>
</ol>
<h2 id="Windows日志分析"><a href="#Windows日志分析" class="headerlink" title="Windows日志分析"></a>Windows日志分析</h2><p>Windows系统日志是记录系统中硬件、软件和系统问题的信息，同时还可以监视系统中发生的事件。用户可以通过它来检查错误发生的原因，或者寻找受到攻击时攻击者留下的痕迹。</p>
<p>系统和应用程序日志存储着故障排除信息，对于系统管理员更为有用。 安全日志记录着事件审计信息，包括用户验证（登录、远程访问等）和特定用户在认证后对系统做了什么，对于调查人员而言，更有帮助。</p>
<h3 id="Windows事件日志说明"><a href="#Windows事件日志说明" class="headerlink" title="Windows事件日志说明"></a>Windows事件日志说明</h3><p>Windows主要有以下三类日志记录系统事件：应用程序日志、系统日志和安全日志。</p>
<ol>
<li><p>应用程序日志，包含由应用程序或系统程序记录的事件，主要记录程序运行方面的事件，例如数据库程序可以在应用程序日志中记录文件错误，程序开发人员可以自行决定监视哪些事件。<br>默认位置：%SystemRoot%\System32\Winevt\Logs\Application.evtx</p>
</li>
<li><p>系统日志，记录操作系统组件产生的事件，主要包括驱动程序、系统组件和应用软件的崩溃以及数据丢失错误等。<br>默认位置：%SystemRoot%\System32\Winevt\Logs\System.evtx</p>
</li>
<li><p>安全日志，记录系统的安全审计事件，包含各种类型的登录日志、对象访问日志、进程追踪日志、特权使用、帐号管理、策略变更、系统事件。安全日志也是调查取证中最常用到的日志。默认设置下，安全性日志是关闭的，管理员可以使用组策略来启动安全性日志，或者在注册表中设置审核策略，以便当安全性日志满后使系统停止响应。<br>默认位置：%SystemRoot%\System32\Winevt\Logs\Security.evtx</p>
</li>
</ol>
<h3 id="Windows事件ID说明"><a href="#Windows事件ID说明" class="headerlink" title="Windows事件ID说明"></a>Windows事件ID说明</h3><p>4624 登录成功<br>4625 登录失败<br>4634 注销成功<br>4647 用户启动的注销<br>4672 使用超级用户（如管理员）进行登录<br>4720 创建用户</p>
<h3 id="Log-Parser日志分析"><a href="#Log-Parser日志分析" class="headerlink" title="Log Parser日志分析"></a>Log Parser日志分析</h3><p>微软公司出品的日志分析工具，它功能强大，使用简单，可以分析基于文本的日志文件、XML文件、CSV文件，以及操作系统的事件日志、注册表、文件系统、Active Directory。它可以像使用SQL语句一样查询分析这些数据，甚至可以把分析结果以各种图表的形式展现出来。</p>
<p>下载地址 <a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/download/details.aspx?id=24659">https://www.microsoft.com/en-us/download/details.aspx?id=24659</a></p>
<p>基本查询结构<br>Logparser.exe –i:EVT –o:DATAGRID “SELECT * FROM c:\xx.evtx”</p>
<p>使用Log Parser分析日志</p>
<ol>
<li><p>登录成功的所有事件<br>LogParser.exe -i:EVT –o:DATAGRID “SELECT * FROM c:\Security.evtx where EventID=4624”</p>
</li>
<li><p>指定登录时间范围的事件：<br>LogParser.exe -i:EVT –o:DATAGRID “SELECT * FROM c:\Security.evtx where TimeGenerated&gt;’2018-06-19 23:32:11’ and TimeGenerated&lt;’2018-06-20 23:34:00’ and EventID=4624”</p>
</li>
<li><p>提取登录成功的用户名和IP：<br>LogParser.exe -i:EVT –o:DATAGRID “SELECT EXTRACT_TOKEN(Message,13,’ ‘) as EventType,TimeGenerated as LoginTime,EXTRACT_TOKEN(Strings,5,’|’) as Username,EXTRACT_TOKEN(Message,38,’ ‘) as Loginip FROM c:\Security.evtx where EventID=4624”</p>
</li>
<li><p>登录失败的所有事件：<br>LogParser.exe -i:EVT –o:DATAGRID “SELECT * FROM c:\Security.evtx where EventID=4625”</p>
</li>
<li><p>提取登录失败用户名进行聚合统计：<br>LogParser.exe -i:EVT “SELECT EXTRACT_TOKEN(Message,13,’ ‘) as EventType,EXTRACT_TOKEN(Message,19,’ ‘) as user,count(EXTRACT_TOKEN(Message,19,’ ‘)) as Times,EXTRACT_TOKEN(Message,39,’ ‘) as Loginip FROM c:\Security.evtx where EventID=4625 GROUP BY Message”</p>
</li>
<li><p>系统历史开关机记录：<br>LogParser.exe -i:EVT –o:DATAGRID “SELECT TimeGenerated,EventID,Message<br>FROM c:\System.evtx where EventID=6005 or EventID=6006”</p>
</li>
</ol>
<h3 id="其他日志分析工具"><a href="#其他日志分析工具" class="headerlink" title="其他日志分析工具"></a>其他日志分析工具</h3><ol>
<li>LogParser Lizard</li>
</ol>
<p>对于GUI环境的Log Parser Lizard，其特点是比较易于使用，甚至不需要记忆繁琐的命令，只需要做好设置，写好基本的SQL语句，就可以直观的得到结果。<br>下载地址：<a target="_blank" rel="noopener" href="http://www.lizard-labs.com/log_parser_lizard.aspx">http://www.lizard-labs.com/log_parser_lizard.aspx</a></p>
<ol start="2">
<li>Event Log Explorer</li>
</ol>
<p>这是非常好用的Windows日志分析工具。可用于查看，监视和分析跟事件记录，包括安全，系统，应用程序和其他微软Windows 的记录被记载的事件，其强大的过滤功能可以快速的过滤出有价值的信息。<br>下载地址：<a target="_blank" rel="noopener" href="https://event-log-explorer.en.softonic.com/">https://event-log-explorer.en.softonic.com/</a></p>
    </div>
  </div>
  
    <div class="copy-right">
      <div class="markdown-body">
        <blockquote>
        
        
          本文作者 : JohnScott <br/>
        
        原文链接 : <a href="">https://github.com/liuxue5213/liuxue5213.github.io/2022/91%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/</a><br>
        版权声明 : 本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！
        </blockquote>
      </div>
    </div>
  
  
  
    <div class="social-share"
  style="margin-top: -2rem"
  data-wechat-qrcode-title="<p>微信扫一扫</p>"
  data-wechat-qrcode-helper="<p>微信右上角, 扫一扫分享</p>"
   data-sites="qzone, qq, weibo, wechat, douban, google, facebook, twitter" 
  
>
  <span style="color: #6b7487; font-size: 1.4rem;">分享到: </span>
</div>
<script src="https://cdn.bootcss.com/social-share.js/1.0.16/js/social-share.min.js" async>
  

  
    <div id="reward">
  
    <p id="reward-meta">知识 & 情怀 | 二者兼得</p>
  
  <button id="reward-btn">
    
    <span>感谢您的关心</span>
  </button>
  <div id="reward-qrcode">
    
      <div class="reward-qrcode--container">
        <img class="qrcode-img" src="/images/wechat.png" alt="微信扫一扫">
        <p class="qrcode-meta">微信扫一扫</p>
      </div>
    
      <div class="reward-qrcode--container">
        <img class="qrcode-img" src="/images/alipay.png" alt="支付宝扫一扫">
        <p class="qrcode-meta">支付宝扫一扫</p>
      </div>
    
  </div>

</div>

<script>
  (() => {
    let button = document.querySelector('#reward-btn'),
      qrcode = document.querySelector('#reward-qrcode'),
      display = false;
    
    button.addEventListener('click', () => {
      qrcode.style.display = display ? 'none' : 'block'
      display = !display
    }, false)
  })()
</script>
  

  <div class="article-footer">
    <div class="article-meta pull-left">
      <span>
        
          <i class="iconfont icon-06tags"></i>标签: 
          
          <span class="span--tag">
            <a href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">
              #网络安全
            </a>
          </span>
          
        
      </span>
    </div>
    <div class="article-meta pull-right">
    </div>
  </div>
</div>


  <aside id="sidebar">
    <p id="sidebar-header"></p>
    <ol id="sidebar-toc"></ol>
  </aside>
  <script async>setTimeout(generateToc, 10);</script>


  <nav class="post-navigation">
    
      <div class="nav-pre">
        <i class="iconfont icon-prev"></i>
        上一篇:
        <a href="/2022/90%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%B3%95/" target="_self">90网络安全法</a>
      </div>
    
    
      <div class="nav-next">
        下一篇:
        <a href="/2022/92%E5%9F%9F/" target="_self">92域</a>
        <i class="iconfont icon-next"></i>
      </div>
    
  </nav>

  
    <a href="#comment" class="comment-anchor"></a>
<div class="comment-title"><i class="iconfont icon-footprint"></i> 留下足迹 <i class="iconfont icon-footprint"></i></div>
<div id="vcomments"></div>

<script defer>
  if( true ) {
    let path = getRealPath()
    new Valine({
      el: "#vcomments",
      appId: "E4f1KI8G9DKenPGcXCkfpCMV-gzGzoHsz",
      appKey: "6VNHrdDAu0JKJXxyMajHk6qD",
      notify: false,
      verify: false,
      avatar: "robohash",
      placeholder: "正确填写邮箱, 才能及时收到回复哦♪(^∇^*)",
      path
    });
  }
</script>
   

  
    <script defer>
const valineAPI = (() => {
  try {
    AV.init("E4f1KI8G9DKenPGcXCkfpCMV-gzGzoHsz", "6VNHrdDAu0JKJXxyMajHk6qD");
  } catch(error) {}
  const isExist = (identity) => {
    identity = identity || getRealPath();
    let query = new AV.Query('Timer');
    return new Promise((resolve, reject) => {
      query.equalTo("identity", identity);
      query.find().then(results => {
        resolve(results.length > 0);
      }, error => reject(error));
    })
  }

  const _get = (identity) => {
    let query = null;
    if(identity && identity instanceof Array){
      let querys = [];
      for(let i = 0; i < identity.length; ++i) {
        querys[i] = new AV.Query('Timer');
        querys[i].equalTo('identity', identity[i]);
      }
      query = AV.Query.or.apply(null ,querys);
    } else {
      identity = identity || getRealPath();
      query = new AV.Query("Timer");
      query.equalTo("identity", identity);
    }

    return new Promise((resolve, reject) => {
      query.find()
      .then(results => resolve(results))
      .catch(error => reject(error))
    })
  }

  const create = (identity) => {
    identity = identity || getRealPath();
    return new Promise((resolve, reject) => {
      let Todo = AV.Object.extend('Timer');
      let todo = new Todo();
      todo.set("times", 1);
      todo.set("identity", identity);
      todo.save().then(res => resolve(true), error => reject(error));
    })
  }

  const update = (identity) => {
    identity = identity || getRealPath();
    return new Promise((resolve, reject) => {
      let query = new AV.Query('Timer');
      query.equalTo("identity", identity);
      query.find().then(todos => {
        todos.forEach(todo => {
          todo.set("times", todo.attributes.times + 1);
        });
        return AV.Object.saveAll(todos);
      }).then(todos => resolve(true), error => reject(error));
    })
  }

  return {
    isExist,
    _get,
    update,
    create
  }
})()

const calcAndWriteTimes = () => {
  let isPost = true;

  let timerAllDOM = document.querySelectorAll(".article-timer");

  if(isPost) {
    let identity = timerAllDOM[0].getAttribute("data-identity");
    valineAPI.isExist(identity)
    .then(exist => {
      if(exist) {
        return valineAPI.update(identity);
      }
      return new Promise(resolve => resolve(true));
    })
    .then( succuess => valineAPI._get(identity))
    .then( result => timerAllDOM[0].innerText = result[0].attributes.times)
    .catch(error => console.log(error.message))
    return ;
  }

  let timerDOMCache = {};

  for(let timerDOM of timerAllDOM) {
    let identity = timerDOM.getAttribute("data-identity");
    if(timerDOMCache.hasOwnProperty(identity)){
      timerDOMCache[identity].dom.push(timerDOM);
    }else{
      timerDOMCache[identity] = {
        dom: [timerDOM],
        times: undefined
      };
    }
  }

  let identities = Object.keys(timerDOMCache);
  valineAPI._get(identities).then(results => {
    for(let result of results) {
      let {identity, times} = result.attributes;
      timerDOMCache[identity].times = times;
      timerDOMCache[identity].dom.map(item => item.innerText = times);
    }
    for(let identity of identities) {
      if(timerDOMCache[identity].times){
        continue;
      }
      timerDOMCache[identity].dom.map(item => item.innerText = 1);
      valineAPI.create(identity);
    }
  }).catch(error => console.log(error.message))
}

if(true){
  calcAndWriteTimes();
}
</script>
   

</div>


      <footer>
  <p class="site-info">
    博客已萌萌哒运行<span id="time-to-now"></span><span class="my-face">(●'◡'●)ﾉ♥</span>
    <br>
    Theme - <a href="https://github.com/dongyuanxin/theme-bmw">BMW</a> | Made With 💗 | Powered by <a target="_blank" rel="noopener" href="https://godbmw.com/">GodBMW</a>
    <br>
    
  </p>
</footer>



<script>
const timeToNowDOM = document.querySelector("#time-to-now");
const startTimestamp = new Date(2015, 0, 1).getTime();

const updateTimeStr = () => {
  let offset = parseInt(
      (new Date().getTime() - startTimestamp) / 1000,
      10
    ),
    day = Math.floor(offset / 86400),
    hour = Math.floor((offset % 86400) / 3600),
    minute = Math.floor(((offset % 86400) % 3600) / 60),
    second = Math.floor(((offset % 86400) % 3600) % 60);
  timeToNowDOM.innerHTML =
    day + "天" + hour + "小时" + minute + "分钟" + second + "秒";
  setTimeout(updateTimeStr, 500);
}

setTimeout(updateTimeStr, 500);
</script>


      <div class="back-to-top hidden">
  <span>
    <i class="iconfont icon-60"></i><span></span>%
  </span>
</div>

<script>
const updateIconToTop = percent => {
  let dom = document.querySelector(".back-to-top span span");
  dom.innerText = percent;
  if(percent < 1) {
    document.querySelector(".back-to-top").className = "back-to-top hidden";
  } else {
    document.querySelector(".back-to-top").className = "back-to-top";
  }
}

const handleScoll = () => {
  let isRunning = false;
  return () => {
    if (isRunning) return;
    isRunning = true;
    window.requestAnimationFrame(timestamp => {
      let scrollTop =
          document.documentElement.scrollTop || document.body.scrollTop,
        scrollHeight =
          document.documentElement.scrollHeight ||
          document.body.scrollHeight,
        clientHeight =
          document.documentElement.clientHeight ||
          document.body.clientHeight;
      isRunning = false;
      if (scrollTop <= 1) {
        updateIconToTop(0);
        return;
      }
      if (scrollTop + clientHeight >= scrollHeight) {
        updateIconToTop(100);
      } else {
        updateIconToTop(parseInt(
          100 * scrollTop / (scrollHeight - clientHeight),
          10
        ));
      }
    });
  };
}

const backToTop = () => {
  let scrollTop =
      document.documentElement.scrollTop || document.body.scrollTop,
    delay = 10,
    time = 200;
  if (scrollTop <= 20) {
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;
    return;
  }
  let step = Math.ceil(scrollTop * delay / time);
  let timer = setInterval(() => {
    scrollTop =
      document.documentElement.scrollTop || document.body.scrollTop;
    if (scrollTop - step <= 0) {
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;
      clearInterval(timer);
    } else {
      document.documentElement.scrollTop = scrollTop - step;
      document.body.scrollTop = scrollTop - step;
    }
  }, delay);
}

document.addEventListener("scroll", handleScoll(), false);

document.querySelector(".back-to-top").addEventListener("click", backToTop, false);

</script>

    </div>

    
      <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<script>
  (() => {
    const mathjaxConfig = {
      showProcessingMessages: false, //关闭js加载过程信息
      messageStyle: "none", //不显示信息
      jax: ["input/TeX", "output/HTML-CSS"],
      tex2jax: {
        inlineMath: [["$", "$"], ["\\(", "\\)"]], //行内公式选择符
        displayMath: [["$$", "$$"], ["\\[", "\\]"]], //段内公式选择符
        skipTags: ["script", "noscript", "style", "textarea", "pre", "code", "a"] //避开某些标签
      },
      "HTML-CSS": {
        availableFonts: ["STIX", "TeX"], //可选字体
        showMathMenu: false //关闭右击菜单显示
      }
    }

    let mathjaxInterval = setInterval(() => {
      if(!window.MathJax){
        return;
      }
      window.MathJax.Hub.Config(mathjaxConfig)
      window.MathJax.Hub.Queue(["Typeset", MathJax.Hub, document.getElementById('app')])

      clearInterval(mathjaxInterval)
    }, 10)    
  })()
</script>
    

    <script src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script>
<script async>
  let fancyTimer = setInterval(function(){
    if(!window.$){
      return;
    }
    $(document).ready(function() {
      $(".post img").each(function () {
        if($(this).parent().get(0).tagName.toLowerCase() === "a") {
          return;
        }
        // $(this).attr("data-fancybox", "gallery"); // if you add 'data-fancybox', img will display after showed
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "gallery");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      });
      
      clearInterval(fancyTimer);
    });
  }, 10);
</script>

    
  </body>

</html>
